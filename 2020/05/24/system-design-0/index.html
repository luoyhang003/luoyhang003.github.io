<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="技术,系统设计,面试," />





  <link rel="alternate" href="/rss2.xml" title="远航" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />




  <meta property="fb:admins" content="luoyhang003@hotmail.com" />
  <meta property="fb:app_id" content="1356944904328979" />



<meta name="description" content="这篇文章是《解构系统设计面试》系列博文的第一篇，在这篇文章里我会介绍一下面试中的系统设计是什么，面试官大体上会从哪些方面来考量系统设计的答案，介绍一种分析系统设计问题的方法论（4S 分析法）以及会以“设计一个新鲜事系统”为例，解构这一经典的系统设计面试题。">
<meta name="keywords" content="技术,系统设计,面试">
<meta property="og:type" content="article">
<meta property="og:title" content="【解构系统设计面试】什么是系统设计？以及如何设计一个新鲜事系统？">
<meta property="og:url" content="http://blog.luoyuanhang.com/2020/05/24/system-design-0/index.html">
<meta property="og:site_name" content="远航">
<meta property="og:description" content="这篇文章是《解构系统设计面试》系列博文的第一篇，在这篇文章里我会介绍一下面试中的系统设计是什么，面试官大体上会从哪些方面来考量系统设计的答案，介绍一种分析系统设计问题的方法论（4S 分析法）以及会以“设计一个新鲜事系统”为例，解构这一经典的系统设计面试题。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/luoyhang003/pics/master/img/system-design-0.001.png">
<meta property="og:image" content="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200528232210.png">
<meta property="og:image" content="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200607153503.png">
<meta property="og:image" content="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200607153944.png">
<meta property="og:image" content="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200607154858.png">
<meta property="og:image" content="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200701003215.png">
<meta property="og:image" content="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200701222850.png">
<meta property="og:image" content="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200701223846.png">
<meta property="og:image" content="http://blog.luoyuanhang.com/Users/luoyuanhang/Library/Application%20Support/typora-user-images/image-20200730014427521.png">
<meta property="og:image" content="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200729001943.png">
<meta property="og:updated_time" content="2020-07-29T17:44:28.141Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【解构系统设计面试】什么是系统设计？以及如何设计一个新鲜事系统？">
<meta name="twitter:description" content="这篇文章是《解构系统设计面试》系列博文的第一篇，在这篇文章里我会介绍一下面试中的系统设计是什么，面试官大体上会从哪些方面来考量系统设计的答案，介绍一种分析系统设计问题的方法论（4S 分析法）以及会以“设计一个新鲜事系统”为例，解构这一经典的系统设计面试题。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/luoyhang003/pics/master/img/system-design-0.001.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":true,"scrollpercent":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>

<script data-ad-client="ca-pub-1343305667561717" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>



  <link rel="canonical" href="http://blog.luoyuanhang.com/2020/05/24/system-design-0/"/>





  <title> 【解构系统设计面试】什么是系统设计？以及如何设计一个新鲜事系统？ | 远航 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '1356944904328979',
      xfbml      : true,
      version    : 'v2.6'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/zh_Hans/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0458911b7b78e99efc3094c783ab5b48";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">远航</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">请叫我：远航</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="http://www.cs.ucr.edu/~yluo069/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-books">
          <a href="/books" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            书单
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.luoyuanhang.com/2020/05/24/system-design-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="远航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ww4.sinaimg.cn/mw690/4858d6a8jw1fabsq6kyp6j20hs0hs76x.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="远航">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                【解构系统设计面试】什么是系统设计？以及如何设计一个新鲜事系统？
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-24T22:44:05+08:00">
                May 24 2020
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/05/24/system-design-0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="http://blog.luoyuanhang.com/2020/05/24/system-design-0/" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/2020/05/24/system-design-0/" class="leancloud_visitors" data-flag-title="【解构系统设计面试】什么是系统设计？以及如何设计一个新鲜事系统？">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>这篇文章是《解构系统设计面试》系列博文的第一篇，在这篇文章里我会介绍一下面试中的系统设计是什么，面试官大体上会从哪些方面来考量系统设计的答案，介绍一种分析系统设计问题的方法论（4S 分析法）以及会以“<strong>设计一个新鲜事系统</strong>”为例，解构这一经典的系统设计面试题。</p>
</blockquote>
<a id="more"></a>
<h1 id="我为什么要写这一系列文章？"><a href="#我为什么要写这一系列文章？" class="headerlink" title="我为什么要写这一系列文章？"></a>我为什么要写这一系列文章？</h1><p>笔者最初萌生写系统设计博客的时候还是 2017 年底的时候，那时候正在北美刷算法题、系统设计题、面向对象设计题等等，备战 FLAG 等大厂的面试。那时笔者准备写这一系列博客的一个主要原因是，将自己学习到的知识通过写博文的形式重新整理消化一遍，同时供自己反复查阅、增补。如今已经 2020 年了，其间的两年多的时间里笔者经历了很多的事情，没有加入北美大厂，回国之后加入了一家区块链公司（<strong>如有兴趣，请见文章末尾投递简历</strong>），逐渐从被面试的面试者走上了面试官的岗位。我对面试者的技术考察主要会关注<strong>项目经历</strong>、<strong>基础知识</strong>、<strong>基本算法</strong>以及<strong>系统设计</strong>等方面，尤其更感兴趣面试者对系统设计问题的解答（当然，具体问题具体分析，对应届毕业生和社招人员的考察方面也会有所侧重）。</p>
<p>从面试者对系统设计问题的解答中，通常能够了解到：</p>
<ul>
<li>面试者对面试本身是否做过充足的准备；</li>
<li>面试者有没有拆解问题的能力；</li>
<li>面试者思路是否清晰；</li>
<li>面试者有没有了解过基本的架构设计；</li>
<li>面试者有没有具体的实操经验；</li>
<li>……</li>
</ul>
<p>总之，<strong>系统设计</strong>是能说明很多问题的，如果你想给面试官一个眼前一亮的印象，对系统设计问题的解答是很重要的，是能很大程度上证明自己的技术素养和技术思维的。除此之外，系统设计往往也是大厂面试中非常看中的一部分。</p>
<p>在面试的过程中，在我和面试者的交流中，系统设计这一环节也是对我自己有很大提升的部分。因为系统设计面试题通常是没有标准答案的，在一步步往下聊、挖掘问题的过程中，常常能够发现新的问题、新的解决方案。我希望，通过这一系列的文章，一方面把系统设计的问题与解决方案总结起来，把这些知识反复迭代消化，让自己对系统设计的理解有所提升，另一方面希望这一系列文章能对面试者们有所帮助。我认为，即便一个技术人员不以面试为目的，也应该去了解一些系统设计的知识与场景，当然，这些积累可能是来源于工作中的项目经验，也可能来源于阅读博客、文章、论文等。</p>
<p><em>（说句题外话，很多人在毕业之后就很少看论文文献了，其实很多论文中包括了很多解决工程问题的方案方法，我还是很推荐大家多了解下大厂发表的论文等，比如这篇文章中提到的<strong>惊群效应</strong>的实际解决方案就来源于 Facebook 发表的 Paper； 比如现在经典的一些分布式系统设计题目多数都脱不开 Google 的三架马车【MapReduce、GFS、BigTable】，笔者这一系列文章会对相关问题进行讨论，对于 GFS 的介绍可以参考笔者另一篇文章 - <a href="http://blog.luoyuanhang.com/2017/05/15/gfs-reading-notes/">《GFS 阅读笔记》</a>）。</em></p>
<p>在文章正题的开始之前，我要感谢<a href="https://www.jiuzhang.com/" target="_blank" rel="noopener">九章算法</a>，是九章在一开始的时候带我进入了系统设计的世界，这一系列文章内容很大一部分也是受九章算法的系统设计课程的启发，对课程中提到的问题进行了解释与延伸，并且加入了我在工作中所遇到的实际问题的思考与解决方案。</p>
<p>下面进入这一系列文章的正题：</p>
<h1 id="系统设计是什么？"><a href="#系统设计是什么？" class="headerlink" title="系统设计是什么？"></a>系统设计是什么？</h1><p>系统设计（System Design）本身是一个很宽泛的话题。在互联网上有各种各样的资源是关于系统设计的，这些资源里更多的是面向准备面试软件工程师岗位的初学者们的。有些面试者往往会把系统设计、面向对象设计以及 API 设计混为一谈，而往往这几种设计是存在区别和联系的：</p>
<ul>
<li><strong>面向对象设计（OO Design）</strong>往往考察的是：<ul>
<li>面向对象的基础知识；</li>
<li>设计模式；</li>
<li>实现一段子系统的代码骨架（Class Design）</li>
</ul>
</li>
<li><strong>API 设计</strong>往往考察的是：<ul>
<li>网站前端与后端程序交互的 API 设计；</li>
<li>或者 APP 与后端程序交互的 API 设计；</li>
<li>（这一面试题往往对有过实际 Web/APP 后端编码经验的面试者来说是小菜一碟）</li>
</ul>
</li>
<li>而<strong>系统设计（System Design）</strong>往往考察的要更为宽泛与全面一些：<ul>
<li>它是一项围绕系统架构设计的面试；</li>
<li>往往会围绕一个具体的技术目标来展开；</li>
<li>通常没有一个最佳的正确答案；</li>
<li>往往需要全面但不那么细节的知识储备</li>
</ul>
</li>
</ul>
<p>系统设计也是不同于程序设计的，通常来说：</p>
<blockquote>
<p><strong>程序 = 算法 + 数据结构</strong></p>
<p><strong>系统 = 服务 + 数据存储</strong></p>
</blockquote>
<p>程序设计是微观上的设计，而系统设计是面向宏观的设计。</p>
<p>这一系列文章会重点围绕着<strong>系统设计</strong>展开，从如何解构系统设计面试题的方法论开始，逐渐引入各种常见的面试题以及实际生产 CASE 的解决方案，可能中间会穿插一部分面向对象设计与 API 设计的内容。</p>
<h2 id="系统设计面试题的形式"><a href="#系统设计面试题的形式" class="headerlink" title="系统设计面试题的形式"></a>系统设计面试题的形式</h2><p>系统设计面试题主要会有下面两种形式：</p>
<p><strong>设计一个 XX 系统</strong>：</p>
<ul>
<li>设计微博 / Twitter；</li>
<li>设计人人 / Facebook；</li>
<li>设计滴滴 / Uber；</li>
<li>设计微信 / Whatsapp；</li>
<li>设计大众点评 / Yelp；</li>
<li>设计短网址系统；</li>
<li>设计 NoSQL 数据库；</li>
<li>……</li>
</ul>
<p><strong>找问题并提出解决方案：</strong></p>
<ul>
<li>网站挂了怎么办？</li>
<li>网站访问太慢怎么办？</li>
<li>网站流量激增怎么办？</li>
<li>……</li>
</ul>
<h2 id="系统设计评分维度"><a href="#系统设计评分维度" class="headerlink" title="系统设计评分维度"></a>系统设计评分维度</h2><p>针对系统设计面试题的解答答案评价，九章算法总结的要从以下方面进行考量，笔者还是很认同的：</p>
<ul>
<li><strong>可行解</strong>：可行解往往是答案最重要的一部分，也是能够引出后续系统设计面试过程的重要一步，往往面试官会从这一可行解中找到可优化或者有缺陷的地方提出针对性的问题，是后续面试过程的基础；</li>
<li><strong>特定问题</strong>：面试者是否有分析饼解决系统设计特定问题的能力；</li>
<li><strong>分析问题</strong>：对一个系统设计问题的分析过程往往比设计这个系统得到的结果更重要；</li>
<li><strong>权衡（tradeoff）</strong>：永远不会有一个在任何场景下都表现最优秀的系统，系统设计的结论往往是权衡利弊的结果（可类比分布式系统设计中的 CAP 定律、不可能三角）；</li>
<li><strong>知识储备</strong>：往往系统设计需要比较全面的知识储备，比如说：缓存、SQL/NoSQL 数据库、分布式基础知识、常见系统架构……</li>
</ul>
<h1 id="如何解构系统设计问题？"><a href="#如何解构系统设计问题？" class="headerlink" title="如何解构系统设计问题？"></a>如何解构系统设计问题？</h1><p>正如这篇文章中【系统设计面试题的形式】这一部分内容中提到的，如果面试官上来抛出了一道形如“请设计一个微博系统”，我相信绝大多数未经过系统设计面试准备的面试者们是很迷茫的，根本不知道从什么地方入手来回答这一问题。出现这一现象是完全正常的，因为这个问题实在是太笼统了，微博一整个系统也太庞大了，从什么地方入手开始设计呢？该如何回答面试官的这一问题呢？</p>
<p>因此，我们需要对系统设计问题进行解构，九章算法提出的 <strong>4S 分析法</strong>就是一套简单、易于理解的方法论，4S 指的是：</p>
<ul>
<li><strong>场景 - Scenario</strong></li>
<li><strong>服务 - Service</strong></li>
<li><strong>存储 - Storage</strong></li>
<li><strong>扩展 - Scale</strong></li>
</ul>
<p>通常，对一道系统设计面试题的解构也是按照上述步骤来依次递进的。接下来，笔者会详细对上述的关键词进行解释与分析：</p>
<h2 id="场景-Scenario"><a href="#场景-Scenario" class="headerlink" title="场景 - Scenario"></a>场景 - Scenario</h2><p>简单来说，<strong>场景</strong>指的是，在这一系统设计中<strong>需要设计哪些功能</strong>、<strong>这一设计需要多牛</strong>（扛得住多少并发、支持多少用户、可用程度能达到什么标准等）。</p>
<p>首先，第一个入手点应该是，这一系统<strong>需要设计哪些功能</strong>，这时开始对该系统的功能列举，然后选择出系统中的核心功能，因为你不可能在短短的面试过程中完成所有功能的设计。通常这一步时，面试官会挑出一个或者几个功能来进行后续问答。</p>
<p>然而，即便是将系统设计问题缩小到了特定功能这一范围，往往还是不能够开始进行设计的。因为不确定系统的规模、用户量是很难进行系统设计的，比如设计一个 100 人使用的微博与 10M 人使用的微博系统肯定是截然不同的，这些指标会影响我们在进行系统设计时的权衡（tradeoff）与策略选择。</p>
<p><strong>而确定场景的过程中往往需要了解一些名词与经验值：</strong></p>
<ul>
<li>日活跃用户（DAU，Daily Active User）</li>
<li>月活跃用户（MAU，Monthly Active User）</li>
<li>读/写频率（QPS，Queries Per Second）</li>
</ul>
<p><strong>而一些经验值的计算如下：</strong></p>
<ul>
<li>并发用户（秒） = 日活跃用户 * 美股用户平均每日请求次数（估算）/ 86400 秒</li>
<li>访问峰值 = 并发用户 * 倍数（通常 2~9 倍都是合理的）</li>
<li>通过上述数值做出对读/写 QPS 的估算</li>
</ul>
<p><strong>分析出 QPS 能够帮助我们确定在设计系统时的规模：</strong></p>
<ul>
<li>QPS &lt; 100：使用单机低配服务器就可以了；</li>
<li>QPS &lt; 1K：稍好一些的中高配服务器（需要考虑单点故障、雪崩问题等）；</li>
<li>QPS 达到 1M：百台以上 Web 服务器集群（需要考虑容错与恢复问题，某一台机器挂了怎么办，如何恢复）</li>
</ul>
<p><strong>QPS 和 Web Server 或者 数据库之间也是存在关联性的：</strong></p>
<ul>
<li>一台 Web Server 的承受量约为 1K QPS；</li>
<li>一台 SQL Database 的承受量约为 1K QPS（如果数据库访问中涵盖大量的 JOIN 和索引相关查询，这一数值会更小）；</li>
<li>一台 NoSQL Database（如 Cassandra）承受量约为 10K QPS；</li>
<li>一台 NoSQL 缓存 Database（如 Memcached 内存 KV 数据库）承受量约为 1M QPS</li>
</ul>
<p>在这一步骤中，最关键的是<strong>要多与面试官交流、多问</strong>，这样才能确定好即将设计的这一系统的功能、系统规模等，而在问与交流的过程中，同时就已经在体现一个面试者的专业程度和思考方式了，这是很重要的一点。</p>
<h2 id="服务-Service"><a href="#服务-Service" class="headerlink" title="服务 - Service"></a>服务 - Service</h2><p>在这一步骤中，面试者需要做的事情是：<strong>将大系统拆分为小服务</strong>。</p>
<p><strong>什么是服务呢？</strong></p>
<ul>
<li>服务其实就是<strong>对逻辑处理的整合</strong>；</li>
<li>把同一类的逻辑处理整合在同一个服务中；</li>
<li>把整个系统拆分为若干个小的服务</li>
</ul>
<p>因此，在这一过程中，需要：</p>
<ul>
<li>第一步 - <strong>Replay</strong>：重新过一下所有需求，为每个需求添加一个或多个服务</li>
<li>第二步 - <strong>Merge</strong>：将相同的服务进行归并</li>
</ul>
<p>这一步是应该很快就能够完成的。</p>
<h2 id="存储-Storage"><a href="#存储-Storage" class="headerlink" title="存储 - Storage"></a>存储 - Storage</h2><p>说到系统设计中的存储，其实就是设计这个系统中的数据是如何进行存储和访问的。简单来讲，就是<strong>什么数据？用什么存？怎么存？</strong></p>
<p>从常用数据库的分类来看，一般会涉及到下面几种数据库类型：</p>
<ul>
<li>SQL 数据库 - 关系型数据库：一般用于存储结构化数据，例如用户信息（Profile）、各种业务表单数据等；</li>
<li>NoSQL 数据库 - 非关系型数据库：一般用于存储非结构化数据，文章、社交图谱等；</li>
<li>文件系统：严格来讲，文件系统其实不属于数据库，但是在系统设计中，作为一种对数据进行存放、读写的容器，也是常常会出现在系统设计的相关问题中的。文件系统可以存放图片（非常推荐小图片可以用 fastDFS 这类分布式存储）、视频。AWS 的 S3 也属于一种文件系统。</li>
</ul>
<p>在系统设计的存储设计中，通常可以分为以下两步：</p>
<ul>
<li>第一步 - <strong>Select</strong>：为每个服务选择合适的存储结构</li>
<li>第二步 - <strong>Schema</strong>：细化数据库的表结构</li>
</ul>
<h2 id="扩展-Scale"><a href="#扩展-Scale" class="headerlink" title="扩展 - Scale"></a>扩展 - Scale</h2><p><strong>扩展</strong>这一部分内容主要围绕的是<strong>该如何对系统进行优化和维护</strong>。</p>
<p>因此，分为两个主要部分：</p>
<ul>
<li>优化（Optimize）：<ul>
<li>解决设计缺陷；</li>
<li>更多功能设计；</li>
<li>特殊用例的设计（极端情况、边界处理）</li>
</ul>
</li>
<li>维护（Maintainance）：<ul>
<li>系统的鲁棒性：如果有一台/几台服务器/数据库挂了，怎么办？</li>
<li>系统的扩展性：如果流量暴增如何扩展系统？</li>
</ul>
</li>
</ul>
<h1 id="CASE：设计一个新鲜事系统"><a href="#CASE：设计一个新鲜事系统" class="headerlink" title="CASE：设计一个新鲜事系统"></a>CASE：设计一个新鲜事系统</h1><p>以上内容对 <strong>4S 分析法</strong>做了一个方法论层面的概述，但是仅仅来谈方法论对很多人来说还是很模糊的，依旧不知道该如何使用这一套方法论来解答系统设计面试题。接下来的内容，会围绕一个经典的系统设计面试题进行展开，一步一步根据上边的方法论来对这一案例进行解构。同时，后边的内容还有许多具体的问题，能够帮助大家更好的理解 4S 分析法以及系统设计面试题的套路。</p>
<p>这一个 CASE 就是：<strong>该如何设计一个新鲜事系统？</strong></p>
<h2 id="新鲜事系统是什么？"><a href="#新鲜事系统是什么？" class="headerlink" title="新鲜事系统是什么？"></a>新鲜事系统是什么？</h2><p>如果要开始设计一个新鲜事系统，就要了解什么是新鲜事系统（News Feed）。在我们的互联网系统中，存在着各种各样的新鲜事系统，其中 Facebook，Twitter，微博，微信朋友圈都属于新鲜事系统。</p>
<p>在新鲜事系统中，有两个概念很容易被混淆，一个是<strong>新鲜事</strong>，另一个是<strong>时间线</strong>。以新浪微博为例，先来解释一下时间线的概念，时间线就是打开一个用户的首页，看到的以时间为序列展示的，该用户的微博、转发等等；而新鲜事则是，你打开微博，看到的你所关注的用户、明星、大V等发布的内容，以时间为序列展示在你的首页的内容。</p>
<p><img src="https://raw.githubusercontent.com/luoyhang003/pics/master/img/system-design-0.001.png" width="750px"></p>
<p>有些人习惯将两个概念反过来区分，这也是没有问题的，只不过本篇文章通篇都会以上边的解释对新鲜事和时间线进行区分。</p>
<h2 id="解构问题（4S-分析法）"><a href="#解构问题（4S-分析法）" class="headerlink" title="解构问题（4S 分析法）"></a>解构问题（4S 分析法）</h2><p>了解了什么是<strong>新鲜事系统</strong>，接下来的内容就要使用 <strong>4S 分析法</strong>来解构这一系统设计问题了。</p>
<h3 id="场景-Scenario-1"><a href="#场景-Scenario-1" class="headerlink" title="场景 - Scenario"></a>场景 - Scenario</h3><p>首先，根据方法论，在场景设计这一阶段首先要分析出这一系统<strong>需要设计那些功能</strong>，最简单的方式就是将这些功能列举出来。</p>
<p>功能列举：</p>
<ul>
<li><strong>发布/转发新鲜事；</strong></li>
<li><strong>时间线/新鲜事；</strong></li>
<li><strong>用户关注/取消关注；</strong></li>
<li>登录/注册；</li>
<li>搜索新鲜事；</li>
<li>用户 Profile 的展示与编辑；</li>
<li>上传图像/视频；</li>
<li>……</li>
</ul>
<p>其中加粗的功能是我认为在一个新鲜事系统里最重要也是面试官最喜欢考察的部分。在系统设计的面试中，要快速的选择出功能列表中哪些功能是该系统中最核心的功能，因为在面试短短的时间里你没有办法做到设计好全部功能的。</p>
<p>挑选出了核心功能，后面一步就是要分析、推断、预测出系统中的用户规模与访问量。下图是 Twitter 的月活跃用户的统计图表：</p>
<p><img src="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200528232210.png" width="750px"></p>
<p>从图表中我们可以看到，Twitter 的 MAU 差不多在 300M，<strong>MAU（月活） 与 DAU（日活）的数量根据经验值来讲大约是两倍的关系</strong>，因此可以推断出 DAU 为 150M 左右。根据 150M 的 DAU，假设用户每天平均请求的次数为 60 次，可以计算出平均每秒的并发访问量约为：150M * 60 / 86400 = 100 K/s。而通常每日访问的峰值大约在平均每秒并发访问量的 2~9 倍，因此，访问峰值的合理估计数值在 200 K/s ~ 900 K/s 之间。</p>
<p>总结一下，我们大约可以推断出来以下与系统规模相关的数字：</p>
<ul>
<li>DAU：150M</li>
<li>MAU：300M</li>
<li>平均每秒并发访问量：300K</li>
<li>读 QPS：300K（读一定比写多）</li>
<li>写 QPS：5K</li>
</ul>
<p>当然，以上数字全部都是<strong>估计与推断</strong>的结果，重要的不是这个推断出来的结果，有时这个推断过程更加重要，言之有理能够给出合理解释即可。但请记住：<strong>系统的性能瓶颈由系统中各个部分的最短板决定</strong>。</p>
<h3 id="服务-Service-1"><a href="#服务-Service-1" class="headerlink" title="服务 - Service"></a>服务 - Service</h3><p>在这一过程中，我们将会执行上边提到的两步：</p>
<ul>
<li>第一步 - <strong>Replay</strong>：重新过一下所有需求，为每个需求添加一个或多个服务</li>
<li>第二步 - <strong>Merge</strong>：将相同的服务进行归并</li>
</ul>
<p>我们可以将新鲜事系统大体上拆分为以下服务，每个服务中会包含场景分析中提到的各个功能：</p>
<ul>
<li>User Service（用户服务）：<ul>
<li>登录</li>
<li>注册</li>
</ul>
</li>
<li>News Service（新鲜事服务）：<ul>
<li>发布/转发新鲜事</li>
<li>新鲜事</li>
<li>时间线</li>
</ul>
</li>
<li>Friendship Service（好友服务）：<ul>
<li>关注好友</li>
<li>取消关注</li>
</ul>
</li>
<li>Media Service（媒体服务）：<ul>
<li>上传图片</li>
<li>上传视频</li>
</ul>
</li>
<li>……</li>
</ul>
<h3 id="存储-Storage-1"><a href="#存储-Storage-1" class="headerlink" title="存储 - Storage"></a>存储 - Storage</h3><p>存储设计，同样是两个步骤：</p>
<ul>
<li>第一步 - <strong>Select</strong>：为每个服务选择合适的存储结构</li>
<li>第二步 - <strong>Schema</strong>：细化数据库的表结构</li>
</ul>
<p><strong>选择合适的存储结构：</strong></p>
<ul>
<li>SQL 关系型数据库<ul>
<li>用户信息</li>
</ul>
</li>
<li>NoSQL 非关系型数据库<ul>
<li>新鲜事内容（推文、微博内容）</li>
<li>社交图谱</li>
</ul>
</li>
<li>文件系统<ul>
<li>图片/视频</li>
</ul>
</li>
</ul>
<p><strong>这是一个简单的表结构设计的实例：</strong></p>
<ul>
<li>针对 User Service（用户服务），我们的用户表可以这样设计：</li>
</ul>
<p>  <img src="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200607153503.png" style="zoom:50%;"></p>
<p>  （通常在数据库中存放的密码都经过hash之后的）</p>
<ul>
<li>Friendship Service（好友服务）可能会包含如下的关系表结构：</li>
</ul>
<p>  <img src="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200607153944.png" style="zoom:50%;"></p>
<p>  该关系表表示的是<code>from</code> 用户关注了<code>to</code>用户，其中的 <code>from_user_id</code> 和 <code>to_user_id</code> 是 <code>User</code>表的外键关联。</p>
<ul>
<li>News Service（新鲜事服务）中用于存储新鲜事的表结构可以这样设计：</li>
</ul>
<p>  <img src="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200607154858.png" style="zoom:50%;"></p>
<h3 id="扩展-Scale-1"><a href="#扩展-Scale-1" class="headerlink" title="扩展 - Scale"></a>扩展 - Scale</h3><p>关于系统扩展部分的设计将会在接下来的每个具体的 CASE 中进行介绍。</p>
<h2 id="Q1：如何存取信息流（News-Feed）-时间线（Timeline）？"><a href="#Q1：如何存取信息流（News-Feed）-时间线（Timeline）？" class="headerlink" title="Q1：如何存取信息流（News Feed）/ 时间线（Timeline）？"></a>Q1：如何存取信息流（News Feed）/ 时间线（Timeline）？</h2><p>在新鲜事系统中，最最重要的部分就是信息流和时间线。因为当用户打开微博或者 Twitter 这类软件时，通常的操作就是：</p>
<ul>
<li>打开首页，看看自己关注的用户们都发布了哪些新内容；</li>
<li>打开某个用户的时间轴，浏览该用户发布过的内容。</li>
</ul>
<p>这一 CASE 会从信息流和时间线的<strong>数据存储</strong>和<strong>数据访问</strong>入手，来分析、权衡如何设计一个合理的系统。</p>
<h3 id="Solution-A：拉模型（Pull-Model）"><a href="#Solution-A：拉模型（Pull-Model）" class="headerlink" title="Solution A：拉模型（Pull Model）"></a>Solution A：拉模型（Pull Model）</h3><p>什么是【拉模型】呢？</p>
<p>拉模型是一个主动型的模型。举个例子，当你打开微博查看自己的新鲜事订阅（其他你所关注的用户发的微博）时，系统会先去取出你所关注的的用户列表，再分别把这些你所关注的的用户的时间线上的微博取出来，最终按时间进行归并排序，返回给你所需要的新鲜事订阅。这一流程就属于拉模型。</p>
<p>拉模型这一表述是很形象的，当你需要获取新鲜事列表时，系统是去你所关注（Follow）用户的时间线列表上去拉取到你所需要的新鲜事。</p>
<p><strong>这一算法可以简单总结如下：</strong></p>
<ol>
<li>用户打开新鲜事列表，获取所有关注的其他用户；</li>
<li>获取这些用户时间轴中的前 100 条新鲜事；</li>
<li>将【2】中取到的新鲜事按时间排序合并成为一个 100 条的新鲜事列表（<strong>K 路归并</strong>）</li>
</ol>
<p><img src="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200701003215.png" style="zoom:50%;"></p>
<p><strong>复杂度分析：</strong></p>
<p>假设该用户有 N 个关注的用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">100 * N 次 DB 读操作 + N 路归并操作</span><br><span class="line">即：100N 次 DB 访问 + 100log(N) 的内存处理操作</span><br></pre></td></tr></table></figure>
<p>通常情况下，内存处理的时间往往要远远小于 DB 访问的时间，因此通常可以忽略不计。在系统设计的考察中，会弱化算法实现的考察，并且算法执行其实在系统设计中，对程序或者系统的执行时间的影响是有限的。</p>
<p>现在我们来分析一下，在【拉模型】下，如果用户发布了一条新鲜事会发生什么：其实在这一模型下，用户发表一条新鲜事是非常简单的，只需要在用户自己的时间轴中插入一条数据即可，也就是进行一次 DB 写操作。</p>
<p><strong>基本伪代码如下：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取新鲜事列表</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNewsFeed</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> followings = db.readFollowings(request.user);</span><br><span class="line">  <span class="keyword">let</span> newsFeedList = [];</span><br><span class="line">  </span><br><span class="line">  followings.forEach(<span class="function"><span class="params">f</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> feeds = db.getTimeLine(f.to_user, <span class="number">100</span>);</span><br><span class="line">    newsFeedList.push(feeds);</span><br><span class="line">  &#125;);</span><br><span class="line">	<span class="keyword">return</span> K_sort(newsFeedList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布新鲜事</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postNews</span>(<span class="params">request, content</span>) </span>&#123;</span><br><span class="line">  db.insertNews(request.user, content);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，这一模型有<strong>一个很明显的缺陷</strong>：那就是，当用户想要拉取自己订阅的新鲜事列表时，需要执行较多的 DB 操作，而这些操作恰恰也是阻塞的，也就意味着用户需要等待这一系列 DB 操作执行完成，系统才回将新鲜事列表返回给客户端显示出来，相比较而言，用户需要等待较长的时间。</p>
<h3 id="Solution-B：推模型（Push-Model）"><a href="#Solution-B：推模型（Push-Model）" class="headerlink" title="Solution B：推模型（Push Model）"></a>Solution B：推模型（Push Model）</h3><p>那么，什么又是【推模型】呢？</p>
<p>在推模型下，你可以理解为，系统为每一个用户都维护了一个新鲜事列表，当某个用户发了一条新鲜事，所有关注该用户的新鲜事列表里都会被插入一条该新鲜事；当一个用户查看自己订阅的新鲜事列表时，仅仅需要从自己的列表中取出前 K 条新鲜事就可以了。</p>
<p><strong>算法描述：</strong></p>
<ol>
<li>为每个用户建立一个存储他的新鲜事的列表，列表中只包含他所关注的用户发布的新鲜事；</li>
<li>当某个用户发布了新鲜事之后，会将该新鲜事逐个推送至每个关注他的用户的新鲜事列表中；</li>
<li>当用户需要查看自己订阅的新鲜事列表时，只需要按时间从该新鲜事列表中取出即可。</li>
</ol>
<p><strong>复杂度分析：</strong></p>
<p>当用户在刷新自己订阅的新鲜事列表时，只需要 1 次 DB 读取即可。</p>
<p>当用户发一条新鲜事时，情况会稍复杂一些，如果该用户被 N 个用户关注，那么则需要执行 N 次 DB 写入。这一操作的好处是，可以做成异步的，在用户的请求到达服务端之后，服务端可以先返回给用户“已经发送成功”的消息，用户无需等待所有数据插入完成，这一操作可以在系统异步地执行，这一操作有一个名词，叫做【Fanout】。</p>
<p><img src="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200701222850.png" style="zoom:50%;"></p>
<p>假设现在有四个用户：</p>
<p>张东升、朱朝阳、严良、老陈，他们之间的好友关系如下所示：</p>
<p><img src="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200701223846.png" style="zoom:50%;"></p>
<ol>
<li>张东升在 2020 年 06 月 20日 8：30 发了一条新鲜事：“一起去爬山啊！”，此时新鲜事数据库表中数据如下：</li>
</ol>
<table>
<thead>
<tr>
<th>id</th>
<th>owner_id</th>
<th>followed_id</th>
<th>news</th>
<th>created_at</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>张东升</td>
<td>朱朝阳</td>
<td>一起去爬山啊！</td>
<td>2020/06/20 08:30:00</td>
</tr>
</tbody>
</table>
<ol start="2">
<li>老陈发了一条新鲜事“今天碰上一个臭小子！”之后：</li>
</ol>
<table>
<thead>
<tr>
<th>id</th>
<th>owner_id</th>
<th>followed_id</th>
<th>news</th>
<th>created_at</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>张东升</td>
<td>朱朝阳</td>
<td>一起去爬山啊！</td>
<td>2020/06/20 08:30:00</td>
</tr>
<tr>
<td>2</td>
<td>老陈</td>
<td>朱朝阳</td>
<td>今天碰上一个臭小子！</td>
<td>2020/06/20 12:00:00</td>
</tr>
</tbody>
</table>
<p>   <img src="/Users/luoyuanhang/Library/Application Support/typora-user-images/image-20200730014427521.png" alt="image-20200730014427521"></p>
<ol start="3">
<li>严良发了一条：“我爸爸在哪呢？”：</li>
</ol>
<table>
<thead>
<tr>
<th>id</th>
<th>owner_id</th>
<th>followed_id</th>
<th>news</th>
<th>created_at</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>张东升</td>
<td>朱朝阳</td>
<td>一起去爬山啊！</td>
<td>2020/06/20 08:30:00</td>
</tr>
<tr>
<td>2</td>
<td>老陈</td>
<td>朱朝阳</td>
<td>今天碰上一个臭小子！</td>
<td>2020/06/20 12:00:00</td>
</tr>
<tr>
<td>3</td>
<td>严良</td>
<td>老陈</td>
<td>我爸爸在哪呢？</td>
<td>2020/06/20 18:00:00</td>
</tr>
<tr>
<td>4</td>
<td>严良</td>
<td>朱朝阳</td>
<td>我爸爸在哪呢？</td>
<td>2020/06/20 18:00:00</td>
</tr>
</tbody>
</table>
<ol start="4">
<li>朱朝阳结束了疲惫的一天发了条“终于记完了今天的日记。”：</li>
</ol>
<table>
<thead>
<tr>
<th>id</th>
<th>owner_id</th>
<th>followed_id</th>
<th>news</th>
<th>created_at</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>张东升</td>
<td>朱朝阳</td>
<td>一起去爬山啊！</td>
<td>2020/06/20 08:30:00</td>
</tr>
<tr>
<td>2</td>
<td>老陈</td>
<td>朱朝阳</td>
<td>今天碰上一个臭小子！</td>
<td>2020/06/20 12:00:00</td>
</tr>
<tr>
<td>3</td>
<td>严良</td>
<td>老陈</td>
<td>我爸爸在哪呢？</td>
<td>2020/06/20 18:00:00</td>
</tr>
<tr>
<td>4</td>
<td>严良</td>
<td>朱朝阳</td>
<td>我爸爸在哪呢？</td>
<td>2020/06/20 18:00:00</td>
</tr>
<tr>
<td>5</td>
<td>朱朝阳</td>
<td>严良</td>
<td>终于记完了今天的日记。</td>
<td>2020/06/20 22:45:00</td>
</tr>
<tr>
<td>6</td>
<td>朱朝阳</td>
<td>张东升</td>
<td>终于记完了今天的日记。</td>
<td>2020/06/20 22:45:00</td>
</tr>
</tbody>
</table>
<p><strong>基本伪代码：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取新鲜事列表</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNewsFeed</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> db.getNews(request.user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布新鲜事</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postNews</span>(<span class="params">request, content</span>) </span>&#123;</span><br><span class="line">  db.insertNews(request.user, content);</span><br><span class="line">  AsyncTask.asyncExec(request.user, content);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AsyncTask.asyncExec = <span class="function">(<span class="params">user, content</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> followings = db.readFollowings(request.user);</span><br><span class="line"></span><br><span class="line"> 	followings.forEach(<span class="function"><span class="params">f</span> =&gt;</span> &#123;</span><br><span class="line">	  db.insertNews(f, content);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>缺陷：</strong></p>
<ul>
<li><strong>浪费数据库空间：</strong>我们可以看到同一条新鲜事会在数据库表中存储多条（尽管这一问题可以通过在 fanout 的表中，只记录新鲜事 id 来优化，但是相比较而言，这一方案是更浪费数据库存储空间的）；</li>
<li><strong>新鲜事更新可能会不及时：</strong>比如说一个明星有 1M 的粉丝量，整个 Fanout 的过程可能要持续一段时间，有一些粉丝可能已经收到这个明星发布的新鲜事了，但是有的粉丝可能半个小时之后才收到，这是影响用户体验的，一个吃瓜群众肯定是希望第一时间吃到瓜的。</li>
</ul>
<h3 id="哪种方案更好？"><a href="#哪种方案更好？" class="headerlink" title="哪种方案更好？"></a>哪种方案更好？</h3><p>比较两个方案的好坏，首先我们要分别列举出两个方案的优缺点：</p>
<table>
<thead>
<tr>
<th>方案</th>
<th>优点</th>
<th>缺陷</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pull 模型</td>
<td>1. 设计清晰，实现简单<br>2. 通过机器的横向扩展很容易提升性能<br>3. ……</td>
<td>1. 拉取新鲜事列表时，DB 操作较多，且是阻塞的<br>2. ……</td>
</tr>
<tr>
<td>Push 模型</td>
<td>1. 拉取新鲜事列表时 DB 操作更少，更快<br>2. ……</td>
<td>1. 浪费空间<br>2. 不活跃用户会占用大量资源<br>3. 新鲜事更新不及时，影响用户体验<br>4. ……</td>
</tr>
</tbody>
</table>
<p>我们从表格中可以看到，这两个方案其实是各有千秋的。但是在实际系统中，往往更多系统设计会选择使用【拉模型】，比如：</p>
<ul>
<li>Facebook 使用的是 Pull 模型；</li>
<li>Twitter 使用的是 Pull 模型；</li>
<li>Instagram 使用的是 Push + Pull 的模型；</li>
</ul>
<p>往往完全只使用推模型的例子比较少，这一选择可能往往是考虑到了产品方面的问题，比如说用户体验等。</p>
<p>在实际情况中，<strong>如果系统的流量不大，使用 Push 模型是最经济/省力的方法</strong>。</p>
<p>在系统设计面试中，对方案之间的比较进行分析与回答是存在一定误区的：</p>
<ul>
<li><strong>切记不能不坚定想法，在几个方案之间来回摇摆：</strong>比如说面试官对你提出的 Pull 模型提了一点质疑，指出了缺陷，然后你的回答又摇摆到了 Push 模型，说“那我们选用 Push 模型就好了”。这是错误的回答方式。</li>
<li><strong>要展现出 tradeoff 的能力：</strong>要针对当前系统设计方案的缺陷去做权衡。</li>
</ul>
<h3 id="如何优化？"><a href="#如何优化？" class="headerlink" title="如何优化？"></a>如何优化？</h3><p>这一部分我们主要讲的是如何针对上述两种方案的缺陷进行优化。这一部分对应的就是 4S 分析法中的【扩展 - Scale】部分，专注于解决设计中的缺陷。</p>
<h4 id="解决-Pull-模型的缺陷"><a href="#解决-Pull-模型的缺陷" class="headerlink" title="解决 Pull 模型的缺陷"></a>解决 Pull 模型的缺陷</h4><p>我们来分析一下 Pull 模型可能存在的系统瓶颈（bottleneck），我们会发现这一模型最慢的部分发生在用户请求新鲜事列表时，并且这一过程需要消耗用户的等待时间。</p>
<p>针对这一情况我们可以选择在系统中加入缓存（Cache），在访问 DB 之前加入一个缓存层，如果在缓存中命中了，则直接将数据返回给用户，可以大大缩减用户的等待时间。我们知道，一般缓存是存放在系统的内存中的，对缓存的操作是远远快于操作数据库的。</p>
<p>但是缓存我们该缓存什么呢？是缓存每个用户的时间线呢？还是缓存每个用户的新鲜事列表呢？</p>
<ul>
<li><strong>缓存每个用户的时间线（Timeline）：</strong>如果我们缓存每个用户的时间线，就相当于把之前的 N 次（N 为关注的好友的个数） DB 请求替换成了 N 次缓存访问，明显是可以提速的。但是，缓存的空间一般是内存，是很宝贵的，是不能存储海量数据的，因此我们就要做出相应的 tradeoff，比如说，每个用户只缓存最新 1000 条或者最新 100 条的新鲜事；比如说，我们还可以将明星、热点用户（用友大量关注者的用户）的缓存长期保存在缓存系统中，不轻易让缓存失效；</li>
<li><strong>缓存每个用户的新鲜事列表（News Feed）</strong>：如果我们来将每个用户的新鲜事列表缓存起来，那么拉取新鲜事列表是就仅仅需要一次 Cache 访问了。针对没有缓存新鲜事列表的用户，归并 N 个关注好友的最新 100 条新鲜事，取出前 100 条放入缓存中；针对已经做了缓存的用户，只需要归并 N 个用户在某个时间之后的所有新鲜事，加入缓存即可。在这一方案中，我们也可以针对不同的用户来做优化，比如说针对经常使用系统、经常频繁刷新新鲜事的用户做优化，将他们的缓存长期存放，对于一些长期不使用的僵尸用户，将他们的缓存清理掉。</li>
</ul>
<p>提到了缓存，不得不提的就是，由于系统的突然爆发式的访问，造成了缓存的失效该如何处理呢？这就是我们经常会听到的<strong>系统雪崩</strong>和<strong>缓存重建</strong>的问题。针对这一问题，我们会在接下来的问题中探讨一些解决的思路和方案。</p>
<h4 id="解决-Push-模型的缺陷"><a href="#解决-Push-模型的缺陷" class="headerlink" title="解决 Push 模型的缺陷"></a>解决 Push 模型的缺陷</h4><p>首先，Push 模型有一个缺陷是，浪费数据库的存储空间，但是其实这个并不算问题，因为毕竟当前“Disk is cheap.”。</p>
<p>第二，由于 Fanout 的时间可能会比较长，导致用户有可能在自己所关注的用户发布了新鲜事的一段时间后才能够在自己的新鲜事列表里刷到该条消息。对此，我们可以采用一定的方案来提升用户体验，比如说在 Fanout 的时候先对粉丝按照某种规则进行排序，例如，按照用户的活跃度进行排序（可以按最新登录系统的时间进行排序），针对活跃度越高的用户优先进行推送。</p>
<p>另外，针对某些明星用户或者说热点用户（关注他们的用户数量远远大于他们自己所关注用户的数目），整个 Fanout 的时间可能会很长。解决这一个问题有一个很粗暴的方案，就是增加机器的数量，采用分布式 Fanout 的方案。</p>
<h4 id="Push-模型-Pull-模型的方案"><a href="#Push-模型-Pull-模型的方案" class="headerlink" title="Push 模型 + Pull 模型的方案"></a>Push 模型 + Pull 模型的方案</h4><p>其实，还有一种方案，是将 Push 方案 和 Pull 方案结合起来进行优化。</p>
<p>比如说，针对普通用户我们采用 Push 的方案；针对明星这类热点用户，我们在系统里进行标记。对于明星用户发布新鲜事，不进行 Push，也就是不将新鲜事 Push 到关注了这一明星的列表里。当用户需要获取自己的新鲜事列表时，到自己所关注的明星用户的时间线上取，并且合并到自己的 News Feed 列表里。</p>
<h2 id="Q2：热点用户（明星）的迅速涨粉-掉粉（摇摆问题）"><a href="#Q2：热点用户（明星）的迅速涨粉-掉粉（摇摆问题）" class="headerlink" title="Q2：热点用户（明星）的迅速涨粉/掉粉（摇摆问题）"></a>Q2：热点用户（明星）的迅速涨粉/掉粉（摇摆问题）</h2><p>基于上述针对“明星用户”的解决方案，会引发一个“摇摆问题”。这一问题的描述大致如下：</p>
<p>在系统中我们需要标记为热点明星用户采用不同的策略，例如，在上一问题的解决方案中，对于明星用户的处理方式是，将明星用户进行标记，对于非明星用户使用“Push”的方案，对于明星用户采用“Pull”的方案。这会带来什么问题呢？如果系统定义被关注数量有 1M 以上的用户为明星用户，此时有一个用户的被关注数量为 1M，同时存在大量的用户在点击对该用户的关注/取关，这一用户在系统中就会被频繁的被标记为“明星”/“非明星”用户。于是针对这一类“明星用户”，会在“Pull”和“Push”模型之中来回切换，于是会导致有用户收不到该“明星用户”发布的新鲜事。这一问题被称为“摇摆问题”。</p>
<p><img src="https://raw.githubusercontent.com/luoyhang003/pics/master/img/20200729001943.png" style="zoom:30%;"></p>
<p><strong>该如何解决这一问题呢？</strong></p>
<p>其实解决这一问题最简单的方法就是，不会动态的对明星用户进行标记。也就是说，用户的关注、取关行为不会立刻影响到该用户会不会被标记为“明星用户”，这一标记过程可以异步使用一个线程，定期来做。</p>
<p>还有另外一种解决思路，是使用一个缓冲地带，比如给用户加入一个“伪明星”的状态，针对这一状态的用户单独处理。</p>
<h2 id="Q3：僵尸粉会带来哪些问题？"><a href="#Q3：僵尸粉会带来哪些问题？" class="headerlink" title="Q3：僵尸粉会带来哪些问题？"></a>Q3：僵尸粉会带来哪些问题？</h2><p>我们可以来定义一下“僵尸粉”，该类用户主要表示的是在系统中长期不活跃的用户，但是他们也有许多关注的用户，也会有少量的粉丝。而这种用户有时会给系统带来一些不必要的负载，从而影响到整个系统的性能。</p>
<p>其实，我们在系统设计过程中，可以单独针对这一类用户单独处理。比如，我们在系统中对这些长期不活跃的用户进行标记，系统如果使用的是 Push 模型的话，在 Fanout 的过程中，将该类用户设置优先级，放到该过程的最后来执行。</p>
<h2 id="Q3：如何实现关注（Follow）与取关（Unfollow）？"><a href="#Q3：如何实现关注（Follow）与取关（Unfollow）？" class="headerlink" title="Q3：如何实现关注（Follow）与取关（Unfollow）？"></a>Q3：如何实现关注（Follow）与取关（Unfollow）？</h2><p>针对 Follow 与 UnFollow 的实现方案，如果采用的是 Push 模型的话，这里提供一种思路：</p>
<ul>
<li>当一个用户 A 去 Follow 了用户 B 之后：将用户 B 的 Timeline 异步合并到 A 的 New Feed 中；</li>
<li>当一个用户 A 去 Unfollow 了用户 B 之后：将用户 B 的 Timeline 异步从 A 的 New Feed 中删除；</li>
</ul>
<p>采用异步处理的原因是，这一过程可能会比较缓慢，采用异步处理可以迅速给到用户反馈，让用户觉得“似乎已经”关注或者取关完成了。随之带来的问题就是，用户在刷新自己的 News Feed 的时候会发现，可能还会收到自己已经取关的用户的新鲜事。但是终究，该用户的 Timeline 中是会把自己已经取关的用户的新鲜事删掉的。</p>
<h2 id="Q4：明星出轨会带来哪些问题？如何解决？"><a href="#Q4：明星出轨会带来哪些问题？如何解决？" class="headerlink" title="Q4：明星出轨会带来哪些问题？如何解决？"></a>Q4：明星出轨会带来哪些问题？如何解决？</h2><p>我们经常可以看到，微博在吹嘘自己技术架构优秀的时候会提到，当前系统支持“八路明星并发出轨”。其实，这一问题就是描述的是，当系统流量非常大的时候，如何来解决系统不可用，或者工作不正常的问题。</p>
<p>这一问题的关键词是：<strong>惊群效应</strong>、<strong>缓存</strong>、<strong>缓存雪崩</strong>、<strong>缓存重建</strong>。</p>
<p>针对这一问题，我在这篇文章里不会过多进行描述，将会在后续的“数据库与缓存”的主题中进行重点描述。</p>
<p>有兴趣的读者可以先阅读一下这篇 Facebook 发布的非常著名的论文<a href="https://www.usenix.org/system/files/conference/nsdi13/nsdi13-final170_update.pdf" target="_blank" rel="noopener">《Scaling Memcache at Facebook》</a>。</p>
<h2 id="Q5：如何查询共同好友？"><a href="#Q5：如何查询共同好友？" class="headerlink" title="Q5：如何查询共同好友？"></a>Q5：如何查询共同好友？</h2><p>当你去访问一个 Facebook 的个人页面的时候，Facebook 会告诉你，你和他的共同好友有哪些人。其实，不仅仅 Facebook，QQ空间等社交媒体也有这一功能，包括微博也会有查看共同关注这一功能。我们该如何设计这一功能呢？</p>
<p><strong>常规的思路是：</strong></p>
<p>其实针对这一问题的实际需求，没有一个系统会让你展现出来你所有的好友与你之间的共同好友的，一般的系统可能只会展示出来你和另一用户之间共同好友的 Top10 或者 Top20。基于这一需求来考虑，其实是可以简化系统设计的。</p>
<p>如果每次都去请求好友的好友列表进行一次遍历，复杂度将会是 <code>O(N * max(N,M))</code> ，N 是这个用户的好友数，M 是他的好友的好友数量，响应时间会比较慢，但是其实是可以提升响应速度而牺牲一点精确度（其实对用户体验的牺牲也并没那么大），因为基于我们的需求其实只需要 TOP10 就可以的，最终结果差别一两名也影响不大。</p>
<p>针对这一方案的话，也是有对应的优化策略的，比如说：</p>
<ul>
<li>每个用户都额外使用一个表来记录与自己共同好友较多的 Top10 用户列表， 每次用户请求 Top10 时直接返回；</li>
<li>当新加一个好友时，异步使用上述算法去求两个用户之间的共同好友，并且使用共同好友 Top10 表里面的最少共同好友的记录去比较，看是否需要更新结果。 同时，异步地更新这两个好友的共同好友列表，因为有可能由于这次操作他们直接多了一个共同好友。</li>
</ul>
<p><strong>还有一个比较暴力的方法，但是也很科学：</strong></p>
<p>比如说，对于 Facebook 来说是有好友上线的，目前的 Facebook 好友上线是 5000。其实针对系统来说，就算把一个用户的所有好友的 id 存放到缓存（比如 Memcached）中的话也只有 80 KB左右，如果计算交集，即便是不使用 HashMap ，计算量的数量级大概在 10^7，系统的计算反应时间也是毫秒级的，其实直接使用缓存系统 + 暴力也是可行的。因为其实查询共同好友这一功能并不是一个非常常用的功能，通常也不会出现<strong>缓存雪崩</strong>或者<strong>缓存失效</strong>的情况。</p>
<h2 id="Q6：朋友圈的可见-不可见是如何实现的？"><a href="#Q6：朋友圈的可见-不可见是如何实现的？" class="headerlink" title="Q6：朋友圈的可见/不可见是如何实现的？"></a>Q6：朋友圈的可见/不可见是如何实现的？</h2><p>TODO.</p>
<p>这一部分内容其实比较繁琐，需要针对具体业务需求来分析。后续的补充内容应该会针对“微信朋友圈”的策略来做具体分析，敬请关注。</p>
<h2 id="QN：欢迎补充"><a href="#QN：欢迎补充" class="headerlink" title="QN：欢迎补充"></a>QN：欢迎补充</h2><p>欢迎大家在文章底部评论（使用的是 Facebook 提供的 Comment 服务，需要科学上网才能留言）里补充问题，或者提供更好的解决方案。我会定期整理放到文章中。</p>
<p>#总结</p>
<p>最后，请记住以下要点：</p>
<ul>
<li>问清楚需求再设计，不要一开始就设计一个巨牛的系统；</li>
<li>不要做关键词大师，给面试官抛出一堆你自己都不太理解的”专业名词“；</li>
<li>不要试图设计一个最牛的系统，要设计一个<strong>够用</strong>的系统；</li>
<li>先设计一个能基本工作的系统，然后再逐步进行优化；</li>
<li>系统设计没有标准答案，单纯背答案毫无意义，分析过程比结果更重要；</li>
<li>要培养自己通过权衡利弊来设计系统的能力，要把自己的知识储备在分析问题的过程中进行展示。</li>
</ul>
<p>文章最后，夹带一点私货：</p>
<p><strong>欢迎加入南京第三极区块链科技有限公司，简历请投递至：<a href="mailto:hr@d3j.io" target="_blank" rel="noopener">hr@d3j.io</a></strong></p>
<hr>
<blockquote>
<p>本文的版权归作者 <a href="http://blog.luoyuanhang.com">罗远航</a> 所有，采用 <a href="http://creativecommons.org/licenses/by-nc/3.0/" target="_blank" rel="noopener">Attribution-NonCommercial 3.0 License</a>。任何人可以进行转载、分享，但不可在未经允许的情况下用于商业用途；转载请注明出处。感谢配合！</p>
</blockquote>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/技术/" rel="tag"># 技术</a>
          
            <a href="/tags/系统设计/" rel="tag"># 系统设计</a>
          
            <a href="/tags/面试/" rel="tag"># 面试</a>
          
        </div>
      

      
        
          <div class="social-like">
            

            
              <div class="fb_like">
                <div class="fb-like" data-layout="button_count" data-share="true"></div>
              </div>
            
          </div>
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/02/03/coda-introduction/" rel="next" title="coda-introduction">
                <i class="fa fa-chevron-left"></i> coda-introduction
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="fb-comments"
           data-href="http://blog.luoyuanhang.com/2020/05/24/system-design-0/"
           data-numposts="10"
           data-width="100%"
           data-colorscheme="light">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ww4.sinaimg.cn/mw690/4858d6a8jw1fabsq6kyp6j20hs0hs76x.jpg"
               alt="远航" />
          <p class="site-author-name" itemprop="name">远航</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">80</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/rss2.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/luoyhang003" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1213781672" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#我为什么要写这一系列文章？"><span class="nav-number">1.</span> <span class="nav-text">我为什么要写这一系列文章？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#系统设计是什么？"><span class="nav-number">2.</span> <span class="nav-text">系统设计是什么？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#系统设计面试题的形式"><span class="nav-number">2.1.</span> <span class="nav-text">系统设计面试题的形式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统设计评分维度"><span class="nav-number">2.2.</span> <span class="nav-text">系统设计评分维度</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#如何解构系统设计问题？"><span class="nav-number">3.</span> <span class="nav-text">如何解构系统设计问题？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#场景-Scenario"><span class="nav-number">3.1.</span> <span class="nav-text">场景 - Scenario</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务-Service"><span class="nav-number">3.2.</span> <span class="nav-text">服务 - Service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#存储-Storage"><span class="nav-number">3.3.</span> <span class="nav-text">存储 - Storage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展-Scale"><span class="nav-number">3.4.</span> <span class="nav-text">扩展 - Scale</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CASE：设计一个新鲜事系统"><span class="nav-number">4.</span> <span class="nav-text">CASE：设计一个新鲜事系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#新鲜事系统是什么？"><span class="nav-number">4.1.</span> <span class="nav-text">新鲜事系统是什么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解构问题（4S-分析法）"><span class="nav-number">4.2.</span> <span class="nav-text">解构问题（4S 分析法）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#场景-Scenario-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">场景 - Scenario</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务-Service-1"><span class="nav-number">4.2.2.</span> <span class="nav-text">服务 - Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储-Storage-1"><span class="nav-number">4.2.3.</span> <span class="nav-text">存储 - Storage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#扩展-Scale-1"><span class="nav-number">4.2.4.</span> <span class="nav-text">扩展 - Scale</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q1：如何存取信息流（News-Feed）-时间线（Timeline）？"><span class="nav-number">4.3.</span> <span class="nav-text">Q1：如何存取信息流（News Feed）/ 时间线（Timeline）？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-A：拉模型（Pull-Model）"><span class="nav-number">4.3.1.</span> <span class="nav-text">Solution A：拉模型（Pull Model）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-B：推模型（Push-Model）"><span class="nav-number">4.3.2.</span> <span class="nav-text">Solution B：推模型（Push Model）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#哪种方案更好？"><span class="nav-number">4.3.3.</span> <span class="nav-text">哪种方案更好？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何优化？"><span class="nav-number">4.3.4.</span> <span class="nav-text">如何优化？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#解决-Pull-模型的缺陷"><span class="nav-number">4.3.4.1.</span> <span class="nav-text">解决 Pull 模型的缺陷</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解决-Push-模型的缺陷"><span class="nav-number">4.3.4.2.</span> <span class="nav-text">解决 Push 模型的缺陷</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Push-模型-Pull-模型的方案"><span class="nav-number">4.3.4.3.</span> <span class="nav-text">Push 模型 + Pull 模型的方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q2：热点用户（明星）的迅速涨粉-掉粉（摇摆问题）"><span class="nav-number">4.4.</span> <span class="nav-text">Q2：热点用户（明星）的迅速涨粉/掉粉（摇摆问题）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q3：僵尸粉会带来哪些问题？"><span class="nav-number">4.5.</span> <span class="nav-text">Q3：僵尸粉会带来哪些问题？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q3：如何实现关注（Follow）与取关（Unfollow）？"><span class="nav-number">4.6.</span> <span class="nav-text">Q3：如何实现关注（Follow）与取关（Unfollow）？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q4：明星出轨会带来哪些问题？如何解决？"><span class="nav-number">4.7.</span> <span class="nav-text">Q4：明星出轨会带来哪些问题？如何解决？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q5：如何查询共同好友？"><span class="nav-number">4.8.</span> <span class="nav-text">Q5：如何查询共同好友？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q6：朋友圈的可见-不可见是如何实现的？"><span class="nav-number">4.9.</span> <span class="nav-text">Q6：朋友圈的可见/不可见是如何实现的？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QN：欢迎补充"><span class="nav-number">4.10.</span> <span class="nav-text">QN：欢迎补充</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">远航</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="local-search-pop-overlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  
  


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("eM9JCEfdHaFVXynCA1Q6bvCl-gzGzoHsz", "eskPwLi7BFotpcQ5FPxgzcgw");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


  

</body>
</html>
